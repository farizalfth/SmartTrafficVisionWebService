<!doctype html>
<html lang="id">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin Dashboard | Smart Traffic Vision</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-body: #121212;
            --bg-card: #1e1e1e;
            --accent-cyan: #00E5FF;
            --accent-yellow: #FFD600;
            --text-main: #ffffff;
            --text-muted: #a0a0a0;
            --border-color: #333;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Poppins', sans-serif;
            padding-top: 80px;
            padding-bottom: 50px;
        }

        /* Navbar */
        .navbar {
            background-color: rgba(30, 30, 30, 0.95) !important;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
        }

        .navbar-brand {
            font-weight: 700;
            color: var(--accent-cyan) !important;
            letter-spacing: 1px;
        }

        .btn-outline-custom {
            color: var(--accent-cyan);
            border-color: var(--accent-cyan);
            border-radius: 50px;
            padding: 5px 20px;
        }

        .btn-outline-custom:hover {
            background-color: var(--accent-cyan);
            color: #000;
        }

        /* --- CARDS --- */
        .summary-card {
            background: linear-gradient(145deg, #252525, #1a1a1a);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            text-align: center;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: transform 0.3s;
        }

        .summary-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-cyan);
        }

        .summary-card .icon {
            margin-bottom: 15px;
            width: 48px;
            height: 48px;
        }

        .summary-card .value {
            font-size: 2.2rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 5px;
        }

        .summary-card .label {
            font-size: 0.9rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* --- DASHBOARD CARD --- */
        .dashboard-card {
            background-color: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid var(--border-color);
            margin-bottom: 24px;
            height: 100%;
        }

        .card-header-custom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-header-custom h4 {
            margin: 0;
            font-weight: 600;
            font-size: 1.25rem;
            color: var(--accent-cyan);
        }

        /* --- VIDEO PLAYER & AI OVERLAY (UPDATED) --- */
        .video-container {
            width: 100%;
            min-height: 400px;
            background-color: #000;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #444;
            overflow: hidden;
            position: relative;
            /* Penting untuk overlay */
        }

        .video-container iframe {
            width: 100%;
            height: 400px;
            border: none;
        }

        .cctv-card {
            border: 4px solid #444;
            border-radius: 12px;
            padding: 6px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .border-red {
            border-color: #ff3b3b;
            box-shadow: 0 0 15px rgba(255, 59, 59, 0.8);
        }

        .border-yellow {
            border-color: #ffcc00;
            box-shadow: 0 0 15px rgba(255, 204, 0, 0.8);
        }

        .border-green {
            border-color: #00ff88;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.8);
        }


        /* Layer Hasil Analisis (Gambar Screenshot) */
        .analysis-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .analysis-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* Loading Spinner */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            color: var(--accent-cyan);
            z-index: 20;
            flex-direction: column;
        }

        /* Tombol Deteksi */
        .btn-analyze {
            background: linear-gradient(45deg, #FFD600, #FF6D00);
            color: black;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            padding: 6px 20px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 0 10px rgba(255, 214, 0, 0.3);
            text-decoration: none;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-analyze:hover {
            transform: scale(1.05);
            color: black;
        }

        /* --- LAINNYA --- */
        .article-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #333;
            text-decoration: none;
            color: white;
        }

        .article-item:last-child {
            border-bottom: none;
        }

        .article-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .article-item img {
            width: 70px;
            height: 50px;
            border-radius: 6px;
            object-fit: cover;
            margin-right: 15px;
        }

        .form-control,
        .form-select {
            background-color: #2c2c2c;
            border: 1px solid #444;
            color: white;
        }

        .form-control:focus {
            background-color: #2c2c2c;
            color: white;
            border-color: var(--accent-cyan);
            box-shadow: none;
        }

        .period-toggle {
            background-color: #2c2c2c;
            border-radius: 8px;
            padding: 4px;
            display: inline-flex;
        }

        .period-toggle input {
            display: none;
        }

        .period-toggle label {
            padding: 5px 15px;
            font-size: 0.8rem;
            color: #aaa;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .period-toggle input:checked+label {
            background-color: var(--accent-cyan);
            color: #000;
            font-weight: 600;
        }

        .chart-legend-custom {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 12px;
            margin-left: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            /* Membuat teks di kiri, angka di kanan */
            width: 100%;
            margin-bottom: 10px;
        }

        .legend-item div {
            display: flex;
            align-items: center;
            gap: 8px;
            /* Jarak antara titik warna dan teks nama kendaraan */
        }

        .legend-item .fw-bold {
            margin-left: 20px;
            /* Memberi jarak tambahan sebelum angka persen */
            color: var(--accent-cyan);
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            display: inline-block;
        }

        .camera-item {
            background-color: #252525;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            transition: transform 0.2s;
            border: 1px solid transparent;
        }

        .camera-item:hover {
            border-color: var(--accent-cyan);
            transform: translateX(5px);
        }

        .camera-thumb {
            width: 60px;
            height: 40px;
            background-color: #000;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }

        .play-icon {
            color: #ef4444;
            fill: #ef4444;
        }

        .btn-add-camera {
            background-color: var(--accent-cyan);
            color: #000;
            font-weight: 600;
            border-radius: 50px;
            padding: 5px 15px;
            border: none;
            display: flex;
            align-items: center;
        }

        .btn-add-camera:hover {
            background-color: #00B8D4;
            color: #000;
        }

        .server-status-card {
            background: linear-gradient(135deg, #1e1e1e 0%, #252525 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .status-indicator {
            width: 15px;
            height: 15px;
            background-color: #00C853;
            border-radius: 50%;
            box-shadow: 0 0 15px #00C853;
            margin-bottom: 15px;
            animation: pulse 2s infinite;
        }

        .status-bar-container {
            width: 80%;
            height: 6px;
            background-color: #333;
            border-radius: 10px;
            margin-top: 15px;
            overflow: hidden;
        }

        .status-bar-fill {
            height: 100%;
            width: 92%;
            background-color: #00C853;
            border-radius: 10px;
        }

        .modal-content {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            color: white;
        }

        /* Animasi Denyut Cepat */
        @keyframes pulse-fast {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(0, 200, 83, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(0, 200, 83, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(0, 200, 83, 0);
            }
        }

        .status-indicator {
            width: 15px;
            height: 15px;
            background-color: #00C853;
            border-radius: 50%;
            /* Gunakan animasi pulse-fast dengan durasi 0.8s agar cepat */
            animation: pulse-fast 0.8s infinite;
        }

        /* Pastikan kolom row memiliki tinggi yang sama */
        .equal-height {
            display: -webkit-flex;
            display: flex;
            flex-wrap: wrap;
        }

        .equal-height>[class*='col-'] {
            display: flex;
            flex-direction: column;
        }

        .equal-height .dashboard-card {
            flex: 1;
            /* Membuat card mengisi seluruh tinggi kolom */
        }

        /* Pastikan kontainer chart punya ruang bawah untuk label multi-baris */
        #trafficChart {
            margin-bottom: 20px;
        }

        /* Sesuaikan tinggi pembungkus chart jika label terpotong */
        .dashboard-card div[style*="height: 300px"] {
            height: 350px !important;
            /* Tambahkan tinggi agar teks di bawah tanggal muat */
        }
    </style>
</head>

<body>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">SMART TRAFFIC VISION</a>
            <div class="d-flex align-items-center">
                <a href="{{ url_for('logout') }}" class="btn btn-outline-custom">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">

        <!-- BAGIAN 1: RINGKASAN LALU LINTAS -->
        <h4 class="mb-3 fw-bold text-white text-center">Ringkasan Lalu Lintas</h4>
        <div class="row g-4 mb-5 justify-content-center">
            <div class="col-md-3 col-sm-6">
                <div class="summary-card">
                    <i data-lucide="car" class="icon" style="color: white;"></i>
                    <div class="value" id="kendaraanHariIni">-</div>
                    <div class="label">Total Kendaraan</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="summary-card">
                    <i data-lucide="activity" class="icon" style="color: var(--accent-yellow);"></i>
                    <div class="value" id="kepadatanTertinggi">-</div>
                    <div class="label">Kepadatan</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="summary-card">
                    <i data-lucide="gauge" class="icon" style="color: var(--accent-cyan);"></i>
                    <div class="value" id="rataRataKecepatan">-</div>
                    <div class="label">Rata-rata Kecepatan</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="summary-card">
                    <i data-lucide="camera" class="icon" style="color: #FF5252;"></i>
                    <div class="value" id="kameraAktif">-</div>
                    <div class="label">Kamera Aktif</div>
                </div>
            </div>
        </div>

        <!-- BAGIAN 2: LIVE FEED & ARTIKEL -->
        <div class="row g-4 mb-5">
            <!-- Live Feed Player -->
            <div class="col-lg-8">
                <div class="dashboard-card">
                    <div class="card-header-custom">
                        <div class="d-flex align-items-center gap-3">
                            <h4>Live Feed CCTV Utama</h4>
                            <!-- TOMBOL DETEKSI -->
                            <button class="btn-analyze" onclick="performAnalysis()">
                                <i data-lucide="scan-line" size="16"></i> Deteksi Kendaraan
                            </button>
                        </div>
                        <!-- Dropdown Feed -->
                        <select class="form-select form-select-sm bg-dark text-white border-secondary"
                            style="width: 250px;" id="cctvSelect">
                            <option value="">-- Pilih CCTV --</option>
                        </select>
                    </div>

                    <div class="video-container">
                        <!-- IFRAME YOUTUBE -->
                        <iframe id="mainCCTVPlayer" class="d-none" src="" frameborder="0" allowfullscreen></iframe>

                        <!-- PLACEHOLDER -->
                        <div id="cctvPlaceholder" class="text-center text-muted">
                            <i data-lucide="video-off" size="48" class="mb-3"></i><br>
                            Silakan pilih CCTV dari menu di atas untuk melihat tayangan.
                        </div>

                        <!-- HASIL ANALISIS GAMBAR (Overlay) -->
                        <div id="analysisResult" class="analysis-overlay">
                            <img id="analyzedImage" src="" class="analysis-img" alt="Hasil Deteksi">

                            <!-- Tombol Tutup -->
                            <button class="btn btn-sm btn-outline-light position-absolute top-0 end-0 m-3"
                                onclick="closeAnalysis()">
                                <i data-lucide="x"></i> Kembali ke Live
                            </button>

                            <!-- Info Bar Bawah Gambar -->
                            <div
                                class="position-absolute bottom-0 start-0 w-100 p-2 bg-dark bg-opacity-75 text-center text-white border-top border-secondary">
                                <small class="text-info fw-bold">HASIL DETEKSI YOLOv8:</small><br>
                                <span id="analysisText">Menunggu data...</span>
                            </div>
                        </div>

                        <!-- LOADING SPINNER -->
                        <div id="loadingAnalysis" class="loading-overlay">
                            <div class="spinner-border mb-3 text-warning" role="status"
                                style="width: 3rem; height: 3rem;"></div>
                            <span class="fw-bold">Menganalisis Frame Real-time...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Artikel Terbaru -->
            <div class="col-lg-4">
                <div class="dashboard-card">
                    <div class="card-header-custom">
                        <h4>Artikel Terbaru</h4>
                        <a href="{{ url_for('kelola_artikel') }}"
                            class="btn btn-sm btn-outline-secondary rounded-pill">Kelola</a>
                    </div>
                    <div>
                        {% for article in latest_articles %}
                        <a href="#" class="article-item">
                            {% if article.gambar %}
                            <img src="{{ url_for('static', filename='uploads/' + article.gambar) }}">
                            {% else %}
                            <img src="https://via.placeholder.com/70x50">
                            {% endif %}
                            <div>
                                <h6 class="mb-1 fw-bold small text-white">{{ article.judul }}</h6>
                                <small class="text-muted" style="font-size: 0.7rem;">{{ article.tanggal.strftime('%d %b
                                    %Y') }}</small>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- BAGIAN 3: STATISTIK & ANALITIK -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold text-white mb-0">Statistik & Analitik</h4>
            <select class="form-select form-select-sm bg-dark text-white border-secondary" style="width: 250px;"
                id="chartCctvSelect">
                <option value="">Semua Data CCTV</option>
            </select>
        </div>

        <div class="row g-4 mb-5">
            <!-- KIRI: Laporan Data Kendaraan (Tinggi dikunci 850px) -->
            <div class="col-lg-7">
                <div class="dashboard-card"
                    style="height: 850px; display: flex; flex-direction: column; overflow: hidden;">
                    <div class="card-header-custom">
                        <h4 class="fw-bold">Laporan Data Kendaraan</h4>
                        <div class="period-toggle">
                            <input type="radio" id="t_hari" name="trafficPeriod" value="harian" checked
                                onchange="changeTrafficPeriod(this.value)">
                            <label for="t_hari">Hari</label>
                            <input type="radio" id="t_minggu" name="trafficPeriod" value="mingguan"
                                onchange="changeTrafficPeriod(this.value)">
                            <label for="t_minggu">Minggu</label>
                            <input type="radio" id="t_bulan" name="trafficPeriod" value="bulanan"
                                onchange="changeTrafficPeriod(this.value)">
                            <label for="t_bulan">Bulan</label>
                        </div>
                    </div>

                    <!-- Area Grafik: Kunci tinggi di 650px agar label multi-baris tidak mendorong card ke bawah -->
                    <div style="height: 650px; width: 100%; position: relative;">
                        <canvas id="trafficChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- KANAN: Distribusi Kendaraan (Tinggi dikunci 850px) -->
            <div class="col-lg-5">
                <div class="dashboard-card"
                    style="height: 850px; display: flex; flex-direction: column; overflow: hidden;">
                    <div class="card-header-custom">
                        <h4>Distribusi Kendaraan</h4>
                        <span class="badge rounded-pill text-dark"
                            style="background-color: var(--accent-cyan); font-size: 0.7rem; padding: 6px 15px;">REAL
                            TIME</span>
                    </div>

                    <div class="d-flex flex-column align-items-center justify-content-center" style="height: 100%;">
                        <!-- Ukuran kontainer donut chart dikunci -->
                        <div style="height: 280px; width: 280px; position: relative;" class="mb-5">
                            <canvas id="vehicleChart"></canvas>
                        </div>

                        <div class="chart-legend-custom w-100 px-4">
                            <!-- Item Legend tetap seperti sebelumnya -->
                            <div class="legend-item d-flex justify-content-between align-items-center mb-3 p-2"
                                style="background: rgba(255,255,255,0.02); border-radius: 8px;">
                                <div class="d-flex align-items-center">
                                    <span class="legend-color"
                                        style="background: #00E5FF; width:14px; height:14px; display:inline-block; border-radius:50%; margin-right:12px;"></span>
                                    <span style="font-size: 1rem;">Mobil</span>
                                </div>
                                <span class="fw-bold text-info fs-5" id="val-mobil">0%</span>
                            </div>
                            <div class="legend-item d-flex justify-content-between align-items-center mb-3 p-2"
                                style="background: rgba(255,255,255,0.02); border-radius: 8px;">
                                <div class="d-flex align-items-center">
                                    <span class="legend-color"
                                        style="background: #FFD600; width:14px; height:14px; display:inline-block; border-radius:50%; margin-right:12px;"></span>
                                    <span style="font-size: 1rem;">Motor</span>
                                </div>
                                <span class="fw-bold text-info fs-5" id="val-motor">0%</span>
                            </div>
                            <div class="legend-item d-flex justify-content-between align-items-center mb-3 p-2"
                                style="background: rgba(255,255,255,0.02); border-radius: 8px;">
                                <div class="d-flex align-items-center">
                                    <span class="legend-color"
                                        style="background: #00C853; width:14px; height:14px; display:inline-block; border-radius:50%; margin-right:12px;"></span>
                                    <span style="font-size: 1rem;">Bus</span>
                                </div>
                                <span class="fw-bold text-info fs-5" id="val-bus">0%</span>
                            </div>
                            <div class="legend-item d-flex justify-content-between align-items-center mb-3 p-2"
                                style="background: rgba(255,255,255,0.02); border-radius: 8px;">
                                <div class="d-flex align-items-center">
                                    <span class="legend-color"
                                        style="background: #FF5252; width:14px; height:14px; display:inline-block; border-radius:50%; margin-right:12px;"></span>
                                    <span style="font-size: 1rem;">Truk</span>
                                </div>
                                <span class="fw-bold text-info fs-5" id="val-truk">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ANALITIK KOMENTAR ADMIN -->
        <div class="row mb-5 g-4">
            <!-- KIRI: GRAFIK -->
            <div class="col-lg-6">
                <div class="dashboard-card h-100">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="mb-0">Tren Ulasan Masuk</h4>
                        <i data-lucide="trending-up" class="text-warning"></i>
                    </div>
                    <div style="height: 300px; position: relative;">
                        <canvas id="commentChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- KANAN: LIST DATA -->
            <div class="col-lg-6">
                <div class="dashboard-card h-100" style="display: flex; flex-direction: column;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="mb-0">Daftar Ulasan Terbaru</h4>
                        <span class="badge bg-info text-dark" id="commentCount">0 Ulasan</span>
                    </div>

                    <div id="commentList" style="flex: 1; overflow-y: auto; max-height: 400px; padding-right: 10px;">
                        <!-- Ulasan di-render di sini -->
                    </div>
                </div>
            </div>
        </div>

        <!-- BAGIAN 4: MANAJEMEN KAMERA & STATUS SISTEM -->
        <div class="row mb-5 g-4 equal-height">
            <!-- KOLOM KIRI -->
            <div class="col-lg-8">
                <h4 class="mb-3 fw-bold text-white">Manajemen Kamera</h4>
                <div class="dashboard-card h-100">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex gap-2 w-100 me-3">
                            <input type="text" id="cameraSearchInput"
                                class="form-control rounded-pill bg-dark border-secondary text-white"
                                placeholder="Cari kamera berdasarkan nama..." style="max-width: 300px;">
                        </div>
                        <button class="btn-add-camera" data-bs-toggle="modal" data-bs-target="#addCameraModal">
                            <i data-lucide="plus" size="18" class="me-1"></i> Tambah
                        </button>
                    </div>

                    <div id="cameraListContainer">
                        {% for cctv in cctv_list %}
                        <div class="camera-item d-flex align-items-center p-3 mb-2"
                            style="background: rgba(255,255,255,0.05); border-radius: 12px;">
                            <div class="camera-thumb me-3 text-info"><i data-lucide="video"></i></div>
                            <div class="camera-info">
                                <p class="camera-name mb-0 fw-bold">{{ cctv.name }}</p>
                                <p class="camera-loc mb-0 text-muted small"><i data-lucide="map-pin" size="12"></i> ID:
                                    {{ cctv.id }} • Aktif</p>
                            </div>
                            <div class="camera-actions ms-auto d-flex gap-2">
                                <button class="btn btn-sm btn-outline-info border-0"
                                    onclick="openEditModal('{{ cctv.name }}', '{{ cctv.url }}')">
                                    <i data-lucide="pencil" size="18"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger border-0"
                                    onclick="confirmDelete('{{ cctv.name }}')">
                                    <i data-lucide="trash-2" size="18"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- KOLOM KANAN -->
            <div class="col-lg-4">
                <h4 class="mb-3 fw-bold text-white">Status Sistem</h4>
                <!-- Tambahkan d-flex dan justify-content-center agar konten berada di tengah secara vertikal -->
                <div
                    class="dashboard-card server-status-card h-100 d-flex flex-column align-items-center justify-content-center">
                    <div id="serverIndicator" class="status-indicator mb-3"></div>
                    <h5 class="text-white fw-bold mb-1">Server Status</h5>
                    <p id="serverStatusText" class="text-success fw-bold mb-3" style="letter-spacing: 1px;">ONLINE •
                        STABIL</p>

                    <div class="d-flex justify-content-between w-75 text-muted small mb-2">
                        <span>Uptime</span>
                        <span id="serverUptime">0h 0m</span>
                    </div>

                    <div class="status-bar-container mb-3"
                        style="width: 80%; background: #333; height: 8px; border-radius: 10px; overflow: hidden;">
                        <div id="stabilityBar" class="status-bar-fill"
                            style="width: 99%; background: #00C853; height: 100%;"></div>
                    </div>

                    <p class="text-muted small">
                        Terakhir diperbarui: <span id="lastServerUpdate">Baru saja</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Modal Tambah/Edit Kamera -->
        <div class="modal fade" id="addCameraModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header border-bottom-0">
                        <h5 class="modal-title fw-bold">Form Data Kamera</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="mb-3">
                                <label class="form-label text-muted small">Nama Kamera</label>
                                <input type="text" class="form-control" placeholder="Contoh: CCTV Simpang Lima">
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-muted small">URL Stream</label>
                                <input type="text" class="form-control" placeholder="https://...">
                            </div>
                            <button type="submit" class="btn btn-info w-100 fw-bold">Simpan Data</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- JSON Data Helper -->
        <script id="cctv-data" type="application/json">
        {{ cctv_list | tojson }}
    </script>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>

            // --- BAGIAN ANALITIK KOMENTAR ADMIN (SINKRON FIREBASE) ---
            let commentChartInstance = null;

            function refreshCommentsAdmin() {
                fetch('/api/admin/comments_analytics')
                    .then(res => res.json())
                    .then(data => {
                        const ctx = document.getElementById('commentChart');
                        if (!ctx) return;

                        if (commentChartInstance) commentChartInstance.destroy();

                        // --- MODIFIKASI LABEL: Menambahkan Total Keseluruhan & Pengaman Data ---
                        const labels = data.labels || [];
                        const baikData = data.baik || [];
                        const burukData = data.buruk || [];

                        const multiLineLabels = labels.map((label, index) => {
                            const b = baikData[index] || 0;   // Jumlah Baik
                            const br = burukData[index] || 0; // Jumlah Buruk
                            const total = b + br;              // Total (Baik + Buruk)

                            return [
                                label,              // Baris 1: Tanggal (2026-01-14)
                                "──────────",        // Baris 2: Garis pembatas
                                `Baik  : ${b}`,     // Baris 3
                                `Buruk : ${br}`,    // Baris 4
                                `Total : ${total}`   // Baris 5: TOTAL KESELURUHAN
                            ];
                        });

                        commentChartInstance = new Chart(ctx.getContext('2d'), {
                            type: 'bar',
                            data: {
                                labels: multiLineLabels,
                                datasets: [
                                    {
                                        label: 'Puas (Baik)',
                                        data: baikData,
                                        backgroundColor: '#00E5FF',
                                        borderRadius: 5,
                                        barPercentage: 0.6,
                                        categoryPercentage: 0.5
                                    },
                                    {
                                        label: 'Laporan (Buruk)',
                                        data: burukData,
                                        backgroundColor: '#FF5252',
                                        borderRadius: 5,
                                        barPercentage: 0.6,
                                        categoryPercentage: 0.5
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: { stepSize: 1, color: '#888' },
                                        grid: { color: 'rgba(255,255,255,0.05)' }
                                    },
                                    x: {
                                        ticks: {
                                            color: '#ffffff',
                                            font: {
                                                size: 11,
                                                family: "'Poppins', sans-serif",
                                                lineHeight: 1.5
                                            },
                                            padding: 10
                                        },
                                        grid: { display: false }
                                    }
                                },
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'top',
                                        labels: { color: '#888', font: { size: 10 } }
                                    }
                                }
                            }
                        });

                        // --- Update List Komentar (SINKRON WEB & FLUTTER) ---
                        const listContainer = document.getElementById('commentList');
                        const countBadge = document.getElementById('commentCount');
                        const comments = data.list || [];

                        if (countBadge) countBadge.innerText = `${comments.length} Laporan Masyarakat`;

                        let html = '';
                        comments.forEach(c => {
                            // Handle sentimen agar tidak case sensitive (Baik vs baik)
                            const sentimen = (c.sentimen || 'Baik').toLowerCase();
                            const color = sentimen === "baik" ? "#00E5FF" : "#FF5252";

                            html += `
                <div class="mb-3 p-3" style="background: rgba(255,255,255,0.03); border-left: 4px solid ${color}; border-radius: 8px;">
                    <div class="d-flex justify-content-between mb-1">
                        <h6 style="color: ${color}; font-weight: bold; margin:0;">${c.nama || 'Anonim'} 
                            <small style="color:#666; font-size:10px; margin-left:5px;">(${c.sentimen || 'Baik'})</small>
                        </h6>
                        <small style="color:#777; font-size:11px;">${c.hari || ''}, ${c.tanggal || ''}</small>
                    </div>
                    <p style="color:#eee; font-size:13px; margin: 5px 0;">${c.komentar || c.pesan || ''}</p>
                    <div style="text-align:right; font-size:10px; color:#555;">${c.jam || ''}</div>
                </div>`;
                        });

                        if (listContainer) {
                            listContainer.innerHTML = html || '<p class="text-center text-muted">Belum ada data laporan.</p>';
                        }
                        lucide.createIcons();
                    })
                    .catch(err => console.error("Gagal sinkron laporan admin:", err));
            }

            // Polling setiap 5 detik agar real-time
            setInterval(refreshCommentsAdmin, 5000);
            refreshCommentsAdmin();

            // --- GLOBAL VARS ---
            let currentFeedId = null;
            let currentChartId = ""; // Default kosong untuk "Semua CCTV"
            let trafficPeriod = 'harian';
            let vehiclePeriod = 'harian';
            let trafficChartInstance = null;
            let vehicleChartInstance = null;

            document.addEventListener('DOMContentLoaded', function () {
                const rawData = document.getElementById('cctv-data').textContent;
                const cctvData = JSON.parse(rawData);
                const feedSelect = document.getElementById('cctvSelect');
                const chartSelect = document.getElementById('chartCctvSelect');

                // 1. Isi Dropdown CCTV
                if (cctvData.length > 0) {
                    cctvData.forEach(cctv => {
                        let opt = new Option(cctv.name, cctv.id);
                        opt.dataset.stream = cctv.stream_url;
                        feedSelect.appendChild(opt);

                        let opt2 = new Option(cctv.name, cctv.id);
                        chartSelect.appendChild(opt2);
                    });
                }

                // 2. Load Data Awal
                fetchSummary(null);
                updateCharts("");

                // 3. Listener Dropdown Video (Live Feed)
                feedSelect.addEventListener('change', function () {
                    currentFeedId = this.value;
                    if (!currentFeedId) {
                        updatePlayer("");
                        fetchSummary(null);
                        return;
                    }
                    const streamUrl = this.options[this.selectedIndex].dataset.stream;
                    updatePlayer(streamUrl);
                    fetchSummary(currentFeedId);
                });

                // 4. Listener Dropdown Statistik (Grafik)
                chartSelect.addEventListener('change', function () {
                    currentChartId = this.value;
                    updateCharts(currentChartId);
                });

                // ==========================================================
                // --- PENTING: LOGIKA REAL-TIME POLLING (SINKRON FIREBASE) ---
                // ==========================================================

                // Polling Otomatis tiap 5 detik agar data dari YOLO langsung muncul
                setInterval(() => {
                    const chartId = document.getElementById('chartCctvSelect').value;
                    updateCharts(chartId);
                }, 5000);
            });

            // --- CORE FUNCTIONS (API CALLERS) ---

            function updateCharts(id) {
                // 1. Ambil data Tren Kepadatan (Bisa Harian/Mingguan/Bulanan)
                fetchTrafficChart(id, trafficPeriod);

                // 2. Ambil data Distribusi Kendaraan (Selalu Harian/Real-Time hari ini)
                fetchVehicleChart(id, 'harian');
            }

            // Fungsi ganti periode (Harian/Mingguan/Bulanan)
            function changeTrafficPeriod(period) {
                trafficPeriod = period;
                updateCharts(currentChartId);
            }

            function changeVehiclePeriod(period) {
                vehiclePeriod = period;
                updateCharts(currentChartId);
            }

            function fetchSummary(id) {
                let url = `/api/admin/dashboard_summary`;
                if (id) url += `?cctv_id=${id}`;

                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        // Update elemen angka di Dashboard
                        document.getElementById('kendaraanHariIni').innerText = data.kendaraan_hari_ini;
                        document.getElementById('kepadatanTertinggi').innerText = data.kepadatan_tertinggi + "%";
                        document.getElementById('rataRataKecepatan').innerText = data.rata_rata_kecepatan;
                        document.getElementById('kameraAktif').innerText = data.kamera_aktif;
                    })
                    .catch(err => console.error("Summary error:", err));
            }

            // --- FUNGSI PLAYER ---
            function updatePlayer(url) {
                const iframe = document.getElementById('mainCCTVPlayer');
                const placeholder = document.getElementById('cctvPlaceholder');
                // Reset Tampilan Analisis jika ganti video
                closeAnalysis();

                if (url) {
                    iframe.src = url;
                    iframe.classList.remove('d-none');
                    placeholder.classList.add('d-none');
                } else {
                    iframe.src = "";
                    iframe.classList.add('d-none');
                    placeholder.classList.remove('d-none');
                }
            }

            // --- FUNGSI DETEKSI AI (UPDATED: LIVE STREAMING YOLO11) ---
            function performAnalysis() {
                if (!currentFeedId) {
                    alert("Pilih CCTV terlebih dahulu!");
                    return;
                }

                const analysisResult = document.getElementById('analysisResult');
                const loadingOverlay = document.getElementById('loadingAnalysis');
                const analyzedImg = document.getElementById('analyzedImage');
                const analysisText = document.getElementById('analysisText');

                // 1. Tampilkan container utama dan loading
                analysisResult.style.display = 'flex';
                loadingOverlay.style.display = 'flex';
                analysisText.innerText = "Menghubungkan ke YOLO11 Engine...";

                // 2. Bersihkan source gambar lama untuk mencegah glitch
                analyzedImg.src = "";

                // 3. Set URL Stream ke Backend Flask
                // Pastikan di app.py route-nya adalah /video_feed
                const streamUrl = `/video_feed?cctv_id=${currentFeedId}&t=${new Date().getTime()}`;

                // Mulai memuat stream
                analyzedImg.src = streamUrl;

                // 4. Handler saat stream berhasil tersambung (Frame pertama diterima)
                analyzedImg.onload = function () {
                    loadingOverlay.style.display = 'none';
                    analysisText.innerText = "Live Streaming Deteksi (YOLO11) Aktif";
                    console.log("Stream AI berhasil dimuat.");
                };

                // 5. Handler jika terjadi error (Server mati atau URL salah)
                analyzedImg.onerror = function () {
                    loadingOverlay.style.display = 'none';
                    analysisResult.style.display = 'none'; // Sembunyikan kembali karena gagal
                    alert("Gagal memuat stream deteksi. \n1. Pastikan Flask Backend sudah dijalankan. \n2. Pastikan file yolo11n.pt ada di folder project.");
                };

                // 6. Polling Statistik Angka (Mobil, Motor, dll)
                // Karena stream video tidak mengirim data angka, kita ambil terpisah setiap 3 detik
                if (window.statsInterval) clearInterval(window.statsInterval);

                window.statsInterval = setInterval(() => {
                    // Hanya update jika overlay deteksi sedang terbuka
                    if (analysisResult.style.display === 'flex') {
                        updateStatsOnly(currentFeedId);
                    } else {
                        clearInterval(window.statsInterval);
                    }
                }, 3000);
            }

            // Fungsi pembantu untuk update angka di kartu dashboard
            function updateStatsOnly(id) {
                fetch(`/api/admin/dashboard_summary?cctv_id=${id}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data) {
                            document.getElementById('kendaraanHariIni').innerText = data.kendaraan_hari_ini || 0;
                            document.getElementById('kepadatanTertinggi').innerText = (data.kepadatan_tertinggi || 0) + "%";
                            document.getElementById('rataRataKecepatan').innerText = data.rata_rata_kecepatan || "0 km/j";

                            // Update teks kecil di bawah video stream
                            // Anda bisa menyesuaikan ini dengan data dari backend jika tersedia
                            // document.getElementById('analysisText').innerText = `Live: ${data.kendaraan_hari_ini} Kendaraan Terdeteksi`;
                        }
                    })
                    .catch(err => console.error("Gagal update statistik:", err));
            }

            // JANGAN LUPA: Update fungsi closeAnalysis agar streaming berhenti saat ditutup
            function closeAnalysis() {
                const img = document.getElementById('analyzedImage');
                img.src = ""; // Menghentikan request stream ke server
                document.getElementById('analysisResult').style.display = 'none';

                // Hentikan polling statistik
                if (window.statsInterval) clearInterval(window.statsInterval);
            }

            function closeAnalysis() {
                document.getElementById('analysisResult').style.display = 'none';
            }

            // Variable global untuk menyimpan ID CCTV yang sedang aktif

            function fetchSummary(id) {
                if (!id) return; // Jangan panggil jika ID kosong

                fetch(`/api/admin/dashboard_summary?cctv_id=${id}`)
                    .then(res => res.json())
                    .then(data => {
                        // Update elemen HTML berdasarkan ID-nya
                        document.getElementById('kendaraanHariIni').innerText = data.kendaraan_hari_ini;
                        document.getElementById('rataRataKecepatan').innerText = data.rata_rata_kecepatan;
                        document.getElementById('kameraAktif').innerText = data.kamera_aktif;
                    })
                    .catch(err => console.error("Error Dashboard:", err));
            }

            // --- LOGIKA UPDATE OTOMATIS (REAL-TIME POLLING) ---
            setInterval(() => {
                // 1. Ambil ID dari dropdown Statistik & Analitik (Diagram Batang & Lingkaran)
                const selectedId = document.getElementById('chartCctvSelect').value;

                // Update Grafik Batang (Data History)
                // Data ini tetap muncul meski CCTV OFF karena mengambil dari riwayat Firebase
                fetchTrafficChart(chartCctvId, 'harian');

                // Update Grafik Lingkaran (Data Cumulative)
                // Menampilkan perbandingan kendaraan yang pernah terdeteksi (tidak akan nol)
                fetchVehicleChart(chartCctvId, 'harian');

                // 2. Ambil ID dari dropdown Live Feed (Kartu Ringkasan Atas)
                const summaryCctvId = document.getElementById('cctvSelect').value;

                // Jika ada CCTV yang sedang dipilih untuk ditonton, update kartu ringkasannya
                // Jika tidak ada, fetchSummary("") akan mengambil akumulasi semua CCTV
                fetchSummary(summaryCctvId);

                console.log("Sinkronisasi Firebase: Data diperbarui...");
            }, 5000); // Update setiap 5 detik

            // Fungsi Ganti Periode untuk Tren Kepadatan
            function changeTrafficPeriod(period) {
                trafficPeriod = period;
                const chartId = document.getElementById('chartCctvSelect').value;
                fetchTrafficChart(chartId, period);
            }

            function changeVehiclePeriod(period) {
                vehiclePeriod = period;
                fetchVehicleChart(currentChartId, period);
            }

            function fetchTrafficChart(id, period) {
                let url = `/api/admin/traffic_data?cctv_id=${id}`;

                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        const ctx = document.getElementById('trafficChart').getContext('2d');
                        if (trafficChartInstance) trafficChartInstance.destroy();

                        // Hitung Max Data agar skala Y rapi
                        const allTotals = data.labels.map((_, i) =>
                            (Number(data.datasets.mobil[i]) || 0) + (Number(data.datasets.motor[i]) || 0) +
                            (Number(data.datasets.bus[i]) || 0) + (Number(data.datasets.truk[i]) || 0)
                        );
                        const maxVal = Math.max(...allTotals);
                        // Skala maksimal adalah data tertinggi + 20% ruang kosong
                        const chartMax = maxVal > 0 ? Math.ceil((maxVal * 1.2) / 100) * 100 : 500;

                        const multiLineLabels = data.labels.map((label, index) => {
                            const m = data.datasets.mobil[index] || 0;
                            const mt = data.datasets.motor[index] || 0;
                            const b = data.datasets.bus[index] || 0;
                            const t = data.datasets.truk[index] || 0;
                            return [
                                label,
                                "──────────",
                                `Mobil : ${m.toLocaleString()}`,
                                `Motor : ${mt.toLocaleString()}`,
                                `Bus   : ${b.toLocaleString()}`,
                                `Truk  : ${t.toLocaleString()}`,
                                "──────────",
                                `Total : ${(m + mt + b + t).toLocaleString()}`
                            ];
                        });

                        trafficChartInstance = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: multiLineLabels,
                                datasets: [
                                    { label: 'Mobil', data: data.datasets.mobil, backgroundColor: '#00E5FF', barThickness: 40 },
                                    { label: 'Motor', data: data.datasets.motor, backgroundColor: '#FFD600', barThickness: 40 },
                                    { label: 'Bus', data: data.datasets.bus, backgroundColor: '#00C853', barThickness: 40 },
                                    { label: 'Truk', data: data.datasets.truk, backgroundColor: '#FF5252', barThickness: 40 }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false, // Penting agar mengikuti tinggi container div
                                plugins: {
                                    legend: { display: true, labels: { color: '#fff', font: { size: 12 } } }
                                },
                                scales: {
                                    x: {
                                        stacked: true,
                                        ticks: {
                                            color: '#ffffff',
                                            font: { size: 12, family: "'Poppins', sans-serif", lineHeight: 1.4 },
                                            padding: 10,
                                            autoSkip: false
                                        },
                                        grid: { display: false }
                                    },
                                    y: {
                                        stacked: true,
                                        beginAtZero: true, // PAKSA DARI 0
                                        min: 0,            // KUNCI MINIMAL 0
                                        max: chartMax,     // KUNCI MAKSIMAL agar angka 4000 kebawah
                                        ticks: {
                                            color: '#888',
                                            stepSize: chartMax / 5, // Bagi skala jadi 5 bagian rapi
                                            callback: function (value) { return value.toLocaleString(); }
                                        },
                                        grid: { color: 'rgba(255,255,255,0.05)' }
                                    }
                                }
                            }
                        });
                    });
            }

            function fetchVehicleChart(id, period) {
                // Jika id kosong, Flask akan menganggap "Semua Data CCTV"
                let url = `/api/admin/vehicle_distribution?period=${period}`;
                if (id) url += `&cctv_id=${id}`;

                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        console.log("Data Distribusi Diterima:", data); // Debugging di Console

                        const ctx = document.getElementById('vehicleChart').getContext('2d');

                        // 1. Hancurkan chart lama agar tidak tumpang tindih visual
                        if (vehicleChartInstance) vehicleChartInstance.destroy();

                        // 2. Gambar Chart baru
                        vehicleChartInstance = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: data.labels, // ['Mobil', 'Motor', 'Bus', 'Truk']
                                datasets: [{
                                    data: data.data, // Angka jumlah kendaraan asli
                                    backgroundColor: ['#00E5FF', '#FFD600', '#00C853', '#FF5252'],
                                    borderWidth: 0,
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                cutout: '70%',
                                plugins: {
                                    legend: { display: false },
                                    tooltip: { enabled: true }
                                }
                            }
                        });

                        // 3. UPDATE TEKS PERSENTASE (LEGEND) DI SEBELAH KANAN
                        // Fungsi ini akan menyisir elemen span.fw-bold dan menggantinya dengan data Firebase
                        const legendValues = document.querySelectorAll('.chart-legend-custom .legend-item span.fw-bold');

                        if (data.percentages && legendValues.length >= 4) {
                            // Pastikan urutan data.percentages sesuai: [Mobil, Motor, Bus, Truk]
                            legendValues[0].innerText = data.percentages[0]; // Ganti 45% jadi data asli
                            legendValues[1].innerText = data.percentages[1];
                            legendValues[2].innerText = data.percentages[2];
                            legendValues[3].innerText = data.percentages[3];
                        }
                    })
                    .catch(err => console.error("Gagal update grafik distribusi:", err));
            }

            // --- CRUD UI Functions ---

            // 1. FUNGSI PENCARIAN (TAMBAHKAN INI)
            document.getElementById('cameraSearchInput').addEventListener('input', function () {
                const keyword = this.value.toLowerCase(); // Ambil kata kunci dan ubah ke huruf kecil
                const cameraItems = document.querySelectorAll('.camera-item'); // Ambil semua baris kamera

                cameraItems.forEach(item => {
                    // Ambil teks Nama dan Info (ID/Lokasi) dari baris tersebut
                    const name = item.querySelector('.camera-name').innerText.toLowerCase();
                    const info = item.querySelector('.camera-loc').innerText.toLowerCase();

                    // Jika keyword ditemukan di Nama atau Info
                    if (name.includes(keyword) || info.includes(keyword)) {
                        item.style.setProperty('display', 'flex', 'important'); // Tampilkan
                    } else {
                        item.style.setProperty('display', 'none', 'important'); // Sembunyikan
                    }
                });
            });

            // 2. FUNGSI EDIT MODAL
            function openEditModal(name, url) {
                const modal = new bootstrap.Modal(document.getElementById('addCameraModal'));
                document.querySelector('#addCameraModal .modal-title').innerText = "Edit Kamera";

                // Cari input berdasarkan placeholder atau gunakan ID jika Anda sudah menambahkannya di HTML
                const nameInput = document.querySelector('#addCameraModal input[placeholder*="CCTV"]');
                const urlInput = document.querySelector('#addCameraModal input[placeholder*="https"]');

                if (nameInput) nameInput.value = name;
                if (urlInput) urlInput.value = url;

                modal.show();
            }

            // 3. FUNGSI HAPUS
            function confirmDelete(name) {
                if (confirm(`Hapus kamera "${name}"?`)) {
                    // Logika hapus data (Contoh simulasi)
                    alert(`Kamera "${name}" berhasil dihapus.`);
                    // Di sini biasanya Anda akan melakukan fetch('/api/delete_camera/...')
                }
            }

            // --- SERVER STATUS POLLING ---
            function updateServerStatus() {
                fetch('/api/admin/server_status')
                    .then(res => res.json())
                    .then(data => {
                        document.getElementById('serverUptime').innerText = data.uptime;
                        document.getElementById('stabilityBar').style.width = data.stability + "%";
                        document.getElementById('lastServerUpdate').innerText = data.last_update;
                    })
                    .catch(err => {
                        const indicator = document.getElementById('serverIndicator');
                        if (indicator) indicator.style.backgroundColor = "#ff5252";
                        document.getElementById('serverStatusText').innerText = "OFFLINE • ERROR";
                    });
            }

            // Jalankan setiap 10 detik
            setInterval(updateServerStatus, 10000);
            updateServerStatus();

            function fetchTrafficChart(id, period = 'harian') {
                let url = `/api/admin/traffic_data?cctv_id=${id}&period=${period}`;

                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        const ctx = document.getElementById('trafficChart').getContext('2d');
                        if (trafficChartInstance) trafficChartInstance.destroy();

                        const allTotals = data.labels.map((_, i) =>
                            (Number(data.datasets.mobil[i]) || 0) + (Number(data.datasets.motor[i]) || 0) +
                            (Number(data.datasets.bus[i]) || 0) + (Number(data.datasets.truk[i]) || 0)
                        );
                        const maxVal = Math.max(...allTotals);
                        const chartMax = maxVal > 0 ? Math.ceil((maxVal * 1.2) / 100) * 100 : 500;

                        // LABEL SUMBU X (Disederhanakan agar rapi)
                        const simplifiedLabels = data.labels.map((label, index) => {
                            const total = allTotals[index];
                            if (period === 'bulanan') {
                                return [label, `Σ ${total.toLocaleString()}`];
                            } else if (period === 'mingguan') {
                                // label adalah array [Minggu X, Tgl-Tgl]
                                return [label[0], label[1], `Σ ${total.toLocaleString()}`];
                            } else {
                                return [label, `Σ ${total.toLocaleString()}`];
                            }
                        });

                        let barThickness = period === 'bulanan' ? 18 : (period === 'mingguan' ? 55 : 35);

                        trafficChartInstance = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: simplifiedLabels,
                                datasets: [
                                    { label: 'Mobil', data: data.datasets.mobil, backgroundColor: '#00E5FF', barThickness: barThickness },
                                    { label: 'Motor', data: data.datasets.motor, backgroundColor: '#FFD600', barThickness: barThickness },
                                    { label: 'Bus', data: data.datasets.bus, backgroundColor: '#00C853', barThickness: barThickness },
                                    { label: 'Truk', data: data.datasets.truk, backgroundColor: '#FF5252', barThickness: barThickness }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: true, labels: { color: '#fff', font: { size: 11 } } },
                                    tooltip: {
                                        callbacks: {
                                            label: (context) => `${context.dataset.label}: ${context.raw.toLocaleString()}`,
                                            footer: (items) => {
                                                let sum = items.reduce((a, b) => a + b.raw, 0);
                                                return `TOTAL: ${sum.toLocaleString()}`;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        stacked: true,
                                        ticks: { color: '#fff', font: { size: 10 }, maxRotation: 0 },
                                        grid: { display: false }
                                    },
                                    y: {
                                        stacked: true,
                                        beginAtZero: true,
                                        max: chartMax,
                                        ticks: {
                                            color: '#888',
                                            callback: v => v.toLocaleString()
                                        },
                                        grid: { color: 'rgba(255,255,255,0.05)' }
                                    }
                                }
                            }
                        });
                    });
            }
        </script>
</body>

</html>