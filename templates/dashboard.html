<!doctype html>
<html lang="id">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard | Smart Traffic Vision</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-body: #121212;
            --bg-card: #1e1e1e;
            --accent-cyan: #00E5FF;
            --accent-yellow: #FFD600;
            --text-main: #ffffff;
            --text-muted: #a0a0a0;
            --border-color: #333;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Poppins', sans-serif;
            padding-top: 80px;
            padding-bottom: 50px;
        }

        /* Navbar */
        .navbar {
            background-color: rgba(30, 30, 30, 0.95) !important;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
        }

        .navbar-brand {
            font-weight: 700;
            color: var(--accent-cyan) !important;
            letter-spacing: 1px;
        }

        .navbar-nav .nav-link {
            color: var(--text-main) !important;
            font-weight: 500;
            margin-right: 15px;
            transition: color 0.2s ease;
        }

        .navbar-nav .nav-link:hover,
        .navbar-nav .nav-link.active {
            color: var(--accent-cyan) !important;
        }

        .btn-outline-light {
            color: var(--accent-cyan);
            border-color: var(--accent-cyan);
            font-weight: 600;
            border-radius: 50px;
            padding: 5px 20px;
        }

        .btn-outline-light:hover {
            background-color: var(--accent-cyan);
            color: #000;
        }

        /* Summary Cards */
        .summary-card {
            background: linear-gradient(145deg, #252525, #1a1a1a);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            text-align: center;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: transform 0.3s;
        }

        .summary-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-cyan);
        }

        .summary-card .icon {
            margin-bottom: 15px;
            width: 48px;
            height: 48px;
        }

        .summary-card .value {
            font-size: 2.2rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 5px;
        }

        .summary-card .label {
            font-size: 0.9rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Dashboard Cards */
        .dashboard-card {
            background-color: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid var(--border-color);
            margin-bottom: 24px;
            height: 100%;
        }

        .card-header-custom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-header-custom h4 {
            margin: 0;
            font-weight: 600;
            font-size: 1.25rem;
            color: var(--accent-cyan);
        }

        /* Video Player */
        .video-container {
            width: 100%;
            min-height: 400px;
            background-color: #000;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #444;
            overflow: hidden;
        }

        .video-container iframe {
            width: 100%;
            height: 400px;
            border: none;
        }

        /* Article List */
        .article-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #333;
            text-decoration: none;
            color: white;
        }

        .article-item:last-child {
            border-bottom: none;
        }

        .article-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .article-item img {
            width: 70px;
            height: 50px;
            border-radius: 6px;
            object-fit: cover;
            margin-right: 15px;
        }

        /* Chart Controls */
        .period-toggle {
            background-color: #2c2c2c;
            border-radius: 8px;
            padding: 4px;
            display: inline-flex;
        }

        .period-toggle input {
            display: none;
        }

        .period-toggle label {
            padding: 5px 15px;
            font-size: 0.8rem;
            color: #aaa;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .period-toggle input:checked+label {
            background-color: var(--accent-cyan);
            color: #000;
            font-weight: 600;
        }

        /* Custom Legend for Doughnut */
        .chart-legend-custom {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 12px;
            margin-left: 20px;
        }

        .legend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            display: inline-block;
        }

        /* Form Controls */
        .form-select {
            background-color: #2c2c2c;
            border: 1px solid #444;
            color: white;
        }

        .form-select:focus {
            background-color: #2c2c2c;
            color: white;
            border-color: var(--accent-cyan);
            box-shadow: none;
        }

        /* Footer */
        footer {
            background-color: var(--bg-card);
            color: #888;
            font-size: 0.85rem;
            padding: 20px 0;
            border-top: 1px solid #333;
            margin-top: 50px;
        }

        /* Perbaikan Floating Label untuk Tema Gelap */
        .form-floating>label {
            color: var(--text-muted) !important;
            background-color: transparent !important;
            /* Hilangkan kotak putih */
            padding: 1rem 0.75rem;
        }

        .form-floating>.form-control {
            background-color: #1a1a1a !important;
            color: white !important;
            border: 1px solid #444 !important;
            height: calc(3.5rem + 2px);
            /* Standar tinggi floating label */
        }

        /* Warna label saat input aktif atau berisi teks */
        .form-floating>.form-control:focus~label,
        .form-floating>.form-control:not(:placeholder-shown)~label {
            transform: scale(.85) translateY(-1rem) translateX(.15rem);
            color: var(--accent-cyan) !important;
            opacity: 1;
        }

        /* Tombol Kirim */
        .btn-kirim {
            background-color: var(--accent-cyan) !important;
            color: black !important;
            font-weight: 700 !important;
            border: none;
            transition: 0.3s;
        }

        .btn-kirim:hover {
            transform: scale(1.05);
            background-color: #00B8D4 !important;
        }
    </style>
</head>

<body>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">SMART TRAFFIC VISION</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <a href="{{ url_for('login') }}" class="btn btn-outline-light ms-lg-3">Login Admin</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">

        <!-- BAGIAN 1: RINGKASAN LALU LINTAS -->
        <h4 class="mb-3 fw-bold text-white text-center">Ringkasan Lalu Lintas Real-time</h4>
        <div class="row g-4 mb-5 justify-content-center">
            <div class="col-md-3 col-sm-6">
                <div class="summary-card">
                    <i data-lucide="car" class="icon" style="color: white;"></i>
                    <div class="value" id="kendaraanHariIni">-</div>
                    <div class="label">Total Kendaraan</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="summary-card">
                    <i data-lucide="activity" class="icon" style="color: var(--accent-yellow);"></i>
                    <div class="value" id="kepadatanTertinggi">-</div>
                    <div class="label">Kepadatan Saat Ini</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="summary-card">
                    <i data-lucide="gauge" class="icon" style="color: var(--accent-cyan);"></i>
                    <div class="value" id="rataRataKecepatan">-</div>
                    <div class="label">Rata-rata Kecepatan</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="summary-card">
                    <i data-lucide="camera" class="icon" style="color: #FF5252;"></i>
                    <div class="value" id="kameraAktif">-</div>
                    <div class="label">Kamera Aktif</div>
                </div>
            </div>
        </div>

        <!-- BAGIAN 2: LIVE FEED & ARTIKEL -->
        <div class="row g-4 mb-5">
            <!-- Live Feed Player -->
            <div class="col-lg-8">
                <div class="dashboard-card">
                    <div class="card-header-custom">
                        <h4>Live Feed CCTV Utama</h4>
                        <select class="form-select form-select-sm bg-dark text-white border-secondary"
                            style="width: 250px;" id="cctvSelect">
                            <option value="">-- Pilih CCTV untuk Menonton --</option>
                        </select>
                    </div>
                    <div class="video-container">
                        <iframe id="mainCCTVPlayer" class="d-none" src="" frameborder="0" allowfullscreen></iframe>
                        <div id="cctvPlaceholder" class="text-center text-muted">
                            <i data-lucide="video-off" size="48" class="mb-3"></i><br>
                            Silakan pilih CCTV dari menu di atas untuk melihat tayangan.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Artikel Terbaru -->
            <div class="col-lg-4">
                <div class="dashboard-card">
                    <div class="card-header-custom">
                        <h4>Artikel Terbaru</h4>
                        <a href="{{ url_for('read_artikel') }}"
                            class="btn btn-sm btn-outline-secondary rounded-pill">Lihat Semua</a>
                    </div>
                    <div>
                        {% for article in latest_articles %}
                        <a href="{{ url_for('view_artikel_detail', id=article.id) }}" class="article-item">
                            {% if article.gambar %}
                            <img src="{{ url_for('static', filename='uploads/' + article.gambar) }}">
                            {% else %}
                            <img src="https://via.placeholder.com/70x50">
                            {% endif %}
                            <div>
                                <h6 class="mb-1 fw-bold small text-white">{{ article.judul }}</h6>
                                <small class="text-muted" style="font-size: 0.7rem;">{{ article.tanggal.strftime('%d %b
                                    %Y') }}</small>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- BAGIAN 3: STATISTIK & ANALITIK (USER VIEW) -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold text-white mb-0">Statistik & Analitik</h4>
            <select class="form-select form-select-sm bg-dark text-white border-secondary" style="width: 250px;"
                id="chartCctvSelect">
                <option value="">Semua Data CCTV</option>
            </select>
        </div>

        <div class="row g-4 mb-5">
            <!-- KIRI: Laporan Data Kendaraan (Tinggi 850px) -->
            <div class="col-lg-7">
                <div class="dashboard-card"
                    style="height: 850px; display: flex; flex-direction: column; overflow: hidden;">
                    <div class="card-header-custom">
                        <h4 class="fw-bold">Laporan Data Kendaraan</h4>
                        <div class="period-toggle">
                            <input type="radio" id="t_hari" name="trafficPeriod" value="harian" checked
                                onchange="changeTrafficPeriod(this.value)">
                            <label for="t_hari">Hari</label>
                            <input type="radio" id="t_minggu" name="trafficPeriod" value="mingguan"
                                onchange="changeTrafficPeriod(this.value)">
                            <label for="t_minggu">Minggu</label>
                            <input type="radio" id="t_bulan" name="trafficPeriod" value="bulanan"
                                onchange="changeTrafficPeriod(this.value)">
                            <label for="t_bulan">Bulan</label>
                        </div>
                    </div>
                    <!-- Area Grafik: Kunci tinggi di 650px agar label multi-baris muat -->
                    <div style="height: 650px; width: 100%; position: relative;">
                        <canvas id="trafficChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- KANAN: Distribusi Kendaraan (REAL TIME) -->
            <div class="col-lg-5">
                <div class="dashboard-card"
                    style="height: 850px; display: flex; flex-direction: column; overflow: hidden;">
                    <div class="card-header-custom">
                        <h4>Distribusi Kendaraan</h4>
                        <span class="badge rounded-pill text-dark"
                            style="background-color: var(--accent-cyan); font-size: 0.7rem; padding: 6px 15px;">REAL
                            TIME</span>
                    </div>
                    <div class="d-flex flex-column align-items-center justify-content-center h-100">
                        <div style="height: 280px; width: 280px; position: relative;" class="mb-5">
                            <canvas id="vehicleChart"></canvas>
                        </div>
                        <!-- Legend dengan Spasi Rata Kanan-Kiri -->
                        <div class="chart-legend-custom w-100 px-4">
                            <div class="legend-item d-flex justify-content-between align-items-center mb-3 p-2"
                                style="background: rgba(255,255,255,0.02); border-radius: 8px;">
                                <div><span class="legend-color" style="background: #00E5FF;"></span>Mobil</div>
                                <span class="fw-bold text-info fs-5" id="val-mobil">0%</span>
                            </div>
                            <div class="legend-item d-flex justify-content-between align-items-center mb-3 p-2"
                                style="background: rgba(255,255,255,0.02); border-radius: 8px;">
                                <div><span class="legend-color" style="background: #FFD600;"></span>Motor</div>
                                <span class="fw-bold text-info fs-5" id="val-motor">0%</span>
                            </div>
                            <div class="legend-item d-flex justify-content-between align-items-center mb-3 p-2"
                                style="background: rgba(255,255,255,0.02); border-radius: 8px;">
                                <div><span class="legend-color" style="background: #00C853;"></span>Bus</div>
                                <span class="fw-bold text-info fs-5" id="val-bus">0%</span>
                            </div>
                            <div class="legend-item d-flex justify-content-between align-items-center mb-3 p-2"
                                style="background: rgba(255,255,255,0.02); border-radius: 8px;">
                                <div><span class="legend-color" style="background: #FF5252;"></span>Truk</div>
                                <span class="fw-bold text-info fs-5" id="val-truk">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- KOLOM KOMENTAR USER -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="dashboard-card border-0"
                    style="background-color: #1e1e1e; border-radius: 16px; padding: 25px;">
                    <div class="d-flex align-items-center mb-4">
                        <i data-lucide="message-square" class="text-info me-2"></i>
                        <h4 class="mb-0 fw-bold text-white">Kirim Laporan / Komentar Warga</h4>
                    </div>

                    <div class="row g-3">
                        <!-- Input Nama -->
                        <div class="col-md-4">
                            <div class="form-floating">
                                <input type="text" id="comm_nama"
                                    class="form-control bg-dark text-white border-secondary" placeholder="Nama Lengkap">
                                <label class="text-muted">Nama Lengkap</label>
                            </div>
                        </div>

                        <!-- Input Pesan -->
                        <div class="col-md-8">
                            <div class="input-group" style="height: 58px;">
                                <div class="form-floating flex-grow-1">
                                    <input type="text" id="comm_pesan"
                                        class="form-control bg-dark text-white border-secondary"
                                        style="border-radius: 10px 0 0 10px !important;" placeholder="Komentar">
                                    <label class="text-muted">Tulis laporan atau saran anda...</label>
                                </div>
                                <!-- Pastikan ada onclick="sendComment()" -->
                                <button class="btn btn-info text-dark fw-bold px-4" type="button" id="btnKirim"
                                    onclick="sendComment()" style="border-radius: 0 10px 10px 0 !important;">
                                    <i data-lucide="send" size="18" class="me-1"></i> Kirim
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </script>

        <!-- Footer -->
        <footer class="text-center">
            <div class="container">
                <small>© 2025 Smart Traffic Vision | Powered by Kelompok 3 5B Teknik Informatika</small>
            </div>
        </footer>

        <!-- JSON Script untuk Data CCTV -->
        <script id="cctv-data" type="application/json">
        {{ cctv_list | tojson }}
    </script>


        <script>
            lucide.createIcons();

            // --- GLOBAL VARS ---
            let currentFeedId = ""; // Default kosong untuk "Semua CCTV"
            let currentChartId = ""; // Default kosong untuk "Semua CCTV"
            let trafficPeriod = 'harian';
            let vehiclePeriod = 'harian';
            let trafficChartInstance = null;
            let vehicleChartInstance = null;

            document.addEventListener('DOMContentLoaded', function () {

                // 1. Ambil Data CCTV dari JSON Helper
                const rawData = document.getElementById('cctv-data').textContent;
                const cctvData = JSON.parse(rawData);

                const feedSelect = document.getElementById('cctvSelect');
                const chartSelect = document.getElementById('chartCctvSelect');

                if (cctvData.length > 0) {
                    cctvData.forEach(cctv => {
                        // Isi Dropdown Player
                        const optFeed = new Option(cctv.name, cctv.id);
                        optFeed.dataset.stream = cctv.stream_url;
                        feedSelect.appendChild(optFeed);

                        // Isi Dropdown Grafik
                        chartSelect.appendChild(new Option(cctv.name, cctv.id));
                    });
                }

                // 2. Inisialisasi Tampilan Awal
                fetchSummary(""); // Ambil data agregat semua CCTV saat pertama buka
                updateCharts("");

                // 3. Listener: Dropdown Video Player
                feedSelect.addEventListener('change', function () {
                    currentFeedId = this.value;
                    const streamUrl = this.options[this.selectedIndex].dataset.stream || "";
                    updatePlayer(streamUrl);
                    fetchSummary(currentFeedId);
                });

                // 4. Listener: Dropdown Grafik
                chartSelect.addEventListener('change', function () {
                    currentChartId = this.value;
                    updateCharts(currentChartId);
                });

                // --- LOGIKA REAL-TIME POLLING (GABUNGAN) ---
                // Menjalankan semua update (Ringkasan & Grafik) dalam satu waktu setiap 3 detik
                setInterval(() => {
                    const chartId = document.getElementById('chartCctvSelect').value;
                    if (chartId) {
                        // Gunakan trafficPeriod yang sedang terpilih (harian/mingguan/bulanan)
                        fetchTrafficChart(chartId, trafficPeriod);
                        fetchVehicleChart(chartId, 'harian');
                    }

                    const summaryId = document.getElementById('cctvSelect').value;
                    fetchSummary(summaryId);
                }, 3000);

                // Tambahkan Listener pada dropdown grafik
                document.getElementById('chartCctvSelect').addEventListener('change', function () {
                    currentChartId = this.value;
                    updateCharts(currentChartId);
                });

            });

            // --- CORE FUNCTIONS ---

            function updatePlayer(url) {
                const iframe = document.getElementById('mainCCTVPlayer');
                const placeholder = document.getElementById('cctvPlaceholder');
                if (url) {
                    iframe.src = url;
                    iframe.classList.remove('d-none');
                    placeholder.classList.add('d-none');
                } else {
                    iframe.src = "";
                    iframe.classList.add('d-none');
                    placeholder.classList.remove('d-none');
                }
            }

            function fetchSummary(id) {
                // Pastikan memanggil API Public
                let url = `/api/public/dashboard_summary?cctv_id=${id}`;

                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        // Update elemen HTML
                        document.getElementById('kendaraanHariIni').innerText = data.kendaraan_hari_ini;

                        // TAMBAHKAN TANDA % DI SINI
                        document.getElementById('kepadatanTertinggi').innerText = data.kepadatan_tertinggi + "%";

                        document.getElementById('rataRataKecepatan').innerText = data.rata_rata_kecepatan;
                        document.getElementById('kameraAktif').innerText = data.kamera_aktif;
                    })
                    .catch(err => console.error("Gagal sinkron data user:", err));
            }

            // PENTING: Polling setiap 3 detik agar User melihat apa yang dideteksi Admin
            setInterval(() => {
                const selectedId = document.getElementById('cctvSelect').value;
                fetchSummary(selectedId);
            }, 3000);

            function updateCharts(id) {
                // 1. Update Tren Kepadatan (Bisa filter Harian/Mingguan/Bulanan)
                fetchTrafficChart(id, trafficPeriod);

                // 2. Update Distribusi Kendaraan (Selalu Real-time Hari Ini)
                fetchVehicleChart(id, 'harian');
            }

            // Fungsi saat tombol Hari/Minggu/Bulan diklik
            function changeTrafficPeriod(period) {
                trafficPeriod = period; // Simpan status periode yang dipilih
                const chartId = document.getElementById('chartCctvSelect').value;
                fetchTrafficChart(chartId, trafficPeriod);
            }

            // Perbarui bagian setInterval (Polling) agar tetap di periode yang sama
            setInterval(() => {
                const chartId = document.getElementById('chartCctvSelect').value;
                if (chartId) {
                    // Gunakan trafficPeriod agar jika sedang di mode 'Bulan', tidak balik ke 'Hari' otomatis
                    fetchTrafficChart(chartId, trafficPeriod);
                    fetchVehicleChart(chartId, 'harian');
                }

                const summaryId = document.getElementById('cctvSelect').value;
                fetchSummary(summaryId);
            }, 5000); // Update setiap 5 detik
            function changeVehiclePeriod(period) {
                vehiclePeriod = period;
                fetchVehicleChart(currentChartId, period);
            }

            // --- CHART GENERATORS ---

            function fetchTrafficChart(id, period) {
                if (!id) return; // Jangan panggil jika ID kosong

                let url = `/api/public/traffic_data?cctv_id=${id}`;

                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        const ctx = document.getElementById('trafficChart').getContext('2d');
                        if (trafficChartInstance) trafficChartInstance.destroy();

                        if (!data.datasets || !data.labels) return;

                        // LOGIKA MULTI-LINE LABELS (Sama dengan Admin)
                        const multiLineLabels = data.labels.map((label, index) => {
                            const m = data.datasets.mobil[index] || 0;
                            const mt = data.datasets.motor[index] || 0;
                            const b = data.datasets.bus[index] || 0;
                            const t = data.datasets.truk[index] || 0;
                            const total = m + mt + b + t;

                            return [
                                label,
                                "──────────",
                                `Mobil : ${m}`,
                                `Motor : ${mt}`,
                                `Bus   : ${b}`,
                                `Truk  : ${t}`,
                                "──────────",
                                `Total : ${total}`
                            ];
                        });

                        trafficChartInstance = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: multiLineLabels,
                                datasets: [
                                    { label: 'Mobil', data: data.datasets.mobil, backgroundColor: '#00E5FF', barThickness: 40 },
                                    { label: 'Motor', data: data.datasets.motor, backgroundColor: '#FFD600', barThickness: 40 },
                                    { label: 'Bus', data: data.datasets.bus, backgroundColor: '#00C853', barThickness: 40 },
                                    { label: 'Truk', data: data.datasets.truk, backgroundColor: '#FF5252', barThickness: 40 }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    x: {
                                        stacked: true,
                                        ticks: { color: '#fff', font: { size: 12 }, lineHeight: 1.5, padding: 10 },
                                        grid: { display: false }
                                    },
                                    y: {
                                        stacked: true,
                                        beginAtZero: true,
                                        min: 0,
                                        ticks: { color: '#888' },
                                        grid: { color: 'rgba(255,255,255,0.05)' }
                                    }
                                },
                                plugins: {
                                    legend: { display: true, labels: { color: '#fff' } }
                                }
                            }
                        });
                    })
                    .catch(err => console.error("Gagal load grafik user:", err));
            }

            function fetchVehicleChart(id, period) {
                let url = `/api/public/vehicle_distribution?cctv_id=${id}&period=${period}`;

                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        const ctx = document.getElementById('vehicleChart').getContext('2d');
                        if (vehicleChartInstance) vehicleChartInstance.destroy();

                        const hasData = data.data.some(v => v > 0);
                        vehicleChartInstance = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: data.labels,
                                datasets: [{
                                    data: hasData ? data.data : [1],
                                    backgroundColor: hasData ? ['#00E5FF', '#FFD600', '#00C853', '#FF5252'] : ['#333'],
                                    borderWidth: 0
                                }]
                            },
                            options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: false } } }
                        });

                        // Update Legend Persentase
                        if (data.percentages) {
                            document.getElementById('val-mobil').innerText = data.percentages[0];
                            document.getElementById('val-motor').innerText = data.percentages[1];
                            document.getElementById('val-bus').innerText = data.percentages[2];
                            document.getElementById('val-truk').innerText = data.percentages[3];
                        }
                    });
            }

            function fetchVehicleChart(id, period) {
                // Gunakan endpoint API PUBLIC
                let url = `/api/public/vehicle_distribution?cctv_id=${id}&period=${period}`;

                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        const ctx = document.getElementById('vehicleChart').getContext('2d');

                        // 1. Hancurkan chart lama agar tidak error saat render ulang
                        if (vehicleChartInstance) vehicleChartInstance.destroy();

                        // 2. Jika semua data 0, jangan gambar (opsional) atau gambar dengan data minimal
                        const hasData = data.data.some(v => v > 0);

                        // 3. Buat Chart Baru
                        vehicleChartInstance = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: data.labels,
                                datasets: [{
                                    data: hasData ? data.data : [1, 1, 1, 1], // Jika 0 semua, beri dummy transparan
                                    backgroundColor: hasData ? ['#00E5FF', '#FFD600', '#00C853', '#FF5252'] : ['#333', '#333', '#333', '#333'],
                                    borderWidth: 0,
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                cutout: '75%',
                                plugins: {
                                    legend: { display: false },
                                    tooltip: { enabled: hasData }
                                }
                            }
                        });

                        // 4. Update Angka Persentase di Legend (Samping)
                        if (data.percentages) {
                            document.getElementById('val-mobil').innerText = data.percentages[0];
                            document.getElementById('val-motor').innerText = data.percentages[1];
                            document.getElementById('val-bus').innerText = data.percentages[2];
                            document.getElementById('val-truk').innerText = data.percentages[3];
                        }
                    });
            }

            function sendComment() {
                const namaInput = document.getElementById('comm_nama');
                const pesanInput = document.getElementById('comm_pesan');

                const nama = namaInput.value.trim() || "Warga Anonim";
                const pesan = pesanInput.value.trim();

                if (!pesan) return alert("Isi pesan dulu!");

                fetch('/api/submit_comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nama: nama,
                        komentar: pesan // Backend Anda menggunakan key 'komentar'
                    })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === "success") {
                            pesanInput.value = "";
                            alert("Laporan terkirim ke Firebase & Admin!");
                        }
                    });
            }

            function fetchTrafficChart(id, period = 'harian') {
                if (!id) return;

                // PENTING: Menambahkan parameter &period= agar backend tahu data apa yang harus dikirim
                let url = `/api/public/traffic_data?cctv_id=${id}&period=${period}`;

                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        const ctx = document.getElementById('trafficChart').getContext('2d');
                        if (trafficChartInstance) trafficChartInstance.destroy();

                        if (!data.datasets || !data.labels) return;

                        // 1. Hitung Max Data untuk skala Y
                        const allTotals = data.labels.map((_, i) =>
                            (Number(data.datasets.mobil[i]) || 0) + (Number(data.datasets.motor[i]) || 0) +
                            (Number(data.datasets.bus[i]) || 0) + (Number(data.datasets.truk[i]) || 0)
                        );
                        const maxVal = Math.max(...allTotals);
                        const chartMax = maxVal > 0 ? Math.ceil((maxVal * 1.2) / 100) * 100 : 500;

                        // 2. Logika Label agar Rapi (Sesuai Admin)
                        const simplifiedLabels = data.labels.map((label, index) => {
                            const total = allTotals[index];

                            if (period === 'bulanan') {
                                // Bulanan: Nama Bulan & Total Sigma
                                return [label, `Σ ${total.toLocaleString()}`];
                            } else if (period === 'mingguan') {
                                // Mingguan: ["Minggu 1", "1-7 Jan", "Σ Total"]
                                const m_name = Array.isArray(label) ? label[0] : label;
                                const m_date = Array.isArray(label) ? label[1] : "";
                                return [m_name, m_date, `Σ ${total.toLocaleString()}`];
                            } else {
                                // Harian
                                return [label, `Σ ${total.toLocaleString()}`];
                            }
                        });

                        // 3. Atur Ketebalan Batang
                        let barThickness = 35;
                        if (period === 'bulanan') barThickness = 18;
                        if (period === 'mingguan') barThickness = 55;

                        trafficChartInstance = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: simplifiedLabels,
                                datasets: [
                                    { label: 'Mobil', data: data.datasets.mobil, backgroundColor: '#00E5FF', barThickness: barThickness },
                                    { label: 'Motor', data: data.datasets.motor, backgroundColor: '#FFD600', barThickness: barThickness },
                                    { label: 'Bus', data: data.datasets.bus, backgroundColor: '#00C853', barThickness: barThickness },
                                    { label: 'Truk', data: data.datasets.truk, backgroundColor: '#FF5252', barThickness: barThickness }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: true, labels: { color: '#fff' } },
                                    tooltip: {
                                        callbacks: {
                                            label: (ctx) => `${ctx.dataset.label}: ${ctx.raw.toLocaleString()}`,
                                            footer: (items) => `TOTAL: ${items.reduce((a, b) => a + b.raw, 0).toLocaleString()}`
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        stacked: true,
                                        ticks: { color: '#fff', font: { size: 10 }, maxRotation: 0, autoSkip: false },
                                        grid: { display: false }
                                    },
                                    y: {
                                        stacked: true,
                                        beginAtZero: true,
                                        max: chartMax,
                                        ticks: { color: '#888', callback: v => v.toLocaleString() },
                                        grid: { color: 'rgba(255,255,255,0.05)' }
                                    }
                                }
                            }
                        });
                    })
                    .catch(err => console.error("Gagal load grafik:", err));
            }
        </script>
</body>

</html>