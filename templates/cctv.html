<!doctype html>
<html lang="id">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Peta CCTV | Smart Traffic Vision</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-body: #121212;
            --bg-card: #1e1e1e;
            --accent-cyan: #00E5FF;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Poppins', sans-serif;
            padding-top: 80px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Navbar (Sama persis dengan Index) */
        .navbar {
            background-color: rgba(30, 30, 30, 0.95) !important;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #333;
        }

        .navbar-brand {
            font-weight: 700;
            color: var(--accent-cyan) !important;
            letter-spacing: 1px;
        }

        .navbar-nav .nav-link {
            color: var(--text-main) !important;
            margin-right: 15px;
            transition: 0.3s;
        }

        .navbar-nav .nav-link:hover,
        .navbar-nav .nav-link.active {
            color: var(--accent-cyan) !important;
        }

        .btn-outline-custom {
            color: var(--accent-cyan);
            border-color: var(--accent-cyan);
            border-radius: 50px;
            font-weight: 600;
        }

        .btn-outline-custom:hover {
            background-color: var(--accent-cyan);
            color: #000;
        }

        /* Header Section */
        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .page-title {
            font-weight: 800;
            font-size: 2.5rem;
            background: linear-gradient(45deg, #fff, var(--accent-cyan));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .page-subtitle {
            color: var(--text-muted);
            font-size: 1rem;
        }

        /* Map Styling (Mengikuti Index.html) */
        .map-section {
            width: 100%;
            padding-bottom: 50px;
        }

        .map-container {
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            /* Shadow lebih kuat */
            border: 2px solid #333;
            position: relative;
            height: 75vh;
            /* Tinggi peta */
            width: 100%;
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* Styling Popup Leaflet agar rapi dengan video */
        .leaflet-popup-content-wrapper {
            border-radius: 10px;
            padding: 5px;
            box-shadow: 0 3px 14px rgba(0, 0, 0, 0.4);
        }

        .leaflet-popup-content {
            margin: 10px;
            text-align: center;
            width: 260px !important;
        }

        .popup-title {
            font-weight: 700;
            font-size: 1rem;
            color: #333;
            /* Warna gelap karena background popup putih (standar) */
            margin-bottom: 5px;
        }

        .popup-video iframe {
            width: 100%;
            height: 145px;
            border-radius: 6px;
            border: none;
            background: #000;
            margin-top: 5px;
        }

        .btn-popup {
            display: block;
            background-color: var(--accent-cyan);
            color: #000;
            text-decoration: none;
            padding: 5px;
            border-radius: 5px;
            font-weight: 600;
            font-size: 0.8rem;
            margin-top: 8px;
        }

        /* Footer */
        footer {
            background-color: var(--bg-card);
            color: var(--text-muted);
            font-size: 0.85rem;
            padding: 25px 0;
            border-top: 1px solid #333;
            margin-top: auto;
        }
    </style>
</head>

<body>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">SMART TRAFFIC VISION</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <a href="{{ url_for('login') }}" class="btn btn-outline-custom ms-lg-3">Login Admin</a>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="container mb-5">
        <div class="page-header">
            <h2 class="page-title">Peta Lokasi CCTV</h2>
            <p class="page-subtitle">Pantau titik kamera pengawas lalu lintas secara real-time.</p>
        </div>

        <div class="map-section">
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <footer class="text-center">
        <div class="container">
            <small>Â© 2025 Smart Traffic Vision | Powered by Kelompok 3 5B Teknik Informatika</small>
        </div>
    </footer>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        lucide.createIcons();

        document.addEventListener('DOMContentLoaded', function () {
            // 1. Inisialisasi Peta (Titik tengah di antara Demak & Pontianak atau Indonesia Tengah)
            var map = L.map('map').setView([-2.5489, 118.0149], 5);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            var markerGroup = L.layerGroup().addTo(map);

            function updateMapMarkers() {
                fetch('/api/cctv_locations')
                    .then(res => res.json())
                    .then(data => {
                        // Simpan referensi popup yang sedang terbuka agar tidak tertutup saat refresh
                        const openedPopupId = map._popup && map._popup._source ? map._popup._source.options.id : null;

                        markerGroup.clearLayers(); // Hapus marker lama
                        var allMarkers = [];

                        data.forEach(cctv => {
                            // SINKRONISASI KEY: Sesuaikan dengan JSON dari Python (status_lalin)
                            const status = cctv.status_lalin || 'Lancar';
                            const total = cctv.total_sekarang || 0;

                            // Tentukan Warna berdasarkan status dari Firebase
                            let color = '#00C853'; // Hijau (Lancar)
                            if (status === 'Padat') color = '#FFD600'; // Kuning
                            if (status === 'Macet') color = '#FF5252'; // Merah

                            // Buat Circle Marker
                            var marker = L.circleMarker([cctv.lat, cctv.lon], {
                                id: cctv.id, // Simpan ID untuk pengecekan popup
                                radius: 10,
                                fillColor: color,
                                color: "#fff",
                                weight: 2,
                                opacity: 1,
                                fillOpacity: 0.8
                            });

                            // Isi Popup dengan data terbaru
                            var popupContent = `
                    <div style="min-width: 220px; font-family: 'Poppins', sans-serif; text-align: center;">
                        <strong style="color:#333; font-size:14px;">${cctv.name}</strong><br>
                        <div class="mt-2 mb-2">
                            <span class="badge" style="background-color:${color}; color:${color === '#FFD600' ? '#000' : '#fff'}; width:100%; padding: 6px;">
                                KONDISI: ${status.toUpperCase()}
                            </span>
                        </div>
                        <div style="background:#000; border-radius:8px; overflow:hidden; line-height: 0;">
                            <iframe src="${cctv.stream_url}" frameborder="0" style="width:100%; height:120px;"></iframe>
                        </div>
                        <div class="mt-2" style="color: #666; font-size: 13px;">
                            Terdeteksi: <b style="color: #333; font-size: 15px;">${total}</b> Kendaraan
                        </div>
                        <a href="/dashboard" class="btn btn-sm btn-info w-100 mt-2 text-white" style="font-size:11px; border-radius: 5px;">Buka Analitik</a>
                    </div>
                `;

                            marker.bindPopup(popupContent);
                            markerGroup.addLayer(marker);
                            allMarkers.push(marker);

                            // Jika marker ini yang popuonya terbuka tadi, buka kembali
                            if (openedPopupId === cctv.id) {
                                marker.openPopup();
                            }
                        });

                        // Auto-zoom hanya saat pertama kali load
                        if (window.isFirstLoad === undefined && allMarkers.length > 0) {
                            var group = new L.featureGroup(allMarkers);
                            map.fitBounds(group.getBounds(), { padding: [50, 50] });
                            window.isFirstLoad = false;
                        }
                    })
                    .catch(err => console.error("Gagal sinkronisasi peta:", err));
            }

            // Jalankan update pertama kali
            updateMapMarkers();

            // REFRESH STATUS SETIAP 5 DETIK (Real-time Sync)
            setInterval(updateMapMarkers, 5000);
        });
    </script>
</body>

</html>