<!doctype html>
<html lang="id">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Statistik & Analitik | Smart Traffic Vision</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Google Fonts - Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      background-color: #000000;
      color: #e0e0e0;
      font-family: 'Poppins', sans-serif;
      padding-top: 70px;
    }

    /* Navbar */
    .navbar {
      background-color: #1a1a1a !important;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
    }

    .navbar-brand {
      font-weight: 700;
      color: #0dcaf0 !important;
    }

    .navbar-nav .nav-link {
      color: #e0e0e0 !important;
      font-weight: 500;
      margin-right: 15px;
    }

    .navbar-nav .nav-link:hover,
    .navbar-nav .nav-link.active {
      color: #0dcaf0 !important;
    }

    .btn-outline-light {
      color: #0dcaf0;
      border-color: #0dcaf0;
      font-weight: 600;
    }

    .btn-outline-light:hover {
      background-color: #0dcaf0;
      color: #1a1a1a;
    }

    /* Card styles */
    .chart-card {
      background-color: #1a1a1a;
      border: none;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      height: 100%;
      border: 1px solid #333;
    }

    .chart-card h4 {
      font-weight: 600;
      color: #0dcaf0;
      /* Aksen Biru */
      margin-bottom: 25px;
      text-align: center;
    }

    /* Filter Buttons */
    .btn-filter-group .btn {
      background-color: #2c2c2c;
      color: #aaa;
      border: 1px solid #444;
      border-radius: 50px;
      /* Pill shape */
      margin: 0 5px;
      padding: 8px 25px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn-filter-group .btn.active,
    .btn-filter-group .btn:hover {
      background-color: #0dcaf0;
      color: #000;
      border-color: #0dcaf0;
      font-weight: 600;
    }

    /* Form Controls */
    .form-select {
      background-color: #2c2c2c;
      border: 1px solid #444;
      color: white;
      border-radius: 10px;
    }

    .form-select:focus {
      background-color: #2c2c2c;
      color: white;
      border-color: #0dcaf0;
      box-shadow: none;
    }

    /* Footer */
    footer {
      background-color: #1a1a1a;
      color: #888;
      font-size: 0.85rem;
      padding: 20px 0;
      border-top: 1px solid #333;
      margin-top: 50px;
    }
  </style>
</head>

<body>
  <!-- ===== NAVBAR ===== -->
  <header class="navbar navbar-expand-lg navbar-dark fixed-top">
    <div class="container">
      <a class="navbar-brand" href="{{ url_for('index') }}">SMART TRAFFIC VISION</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link" href="{{ url_for('dashboard') }}">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link active" href="{{ url_for('static_page') }}">Statistik & Analitik</a>
          </li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('read_artikel') }}">Artikel</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('about') }}">Tentang Kami</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('cctv_page') }}">Peta CCTV</a></li>
        </ul>
        <a href="{{ url_for('login') }}" class="btn btn-outline-light rounded-pill ms-lg-3">Login Admin</a>
      </div>
    </div>
  </header>

  <!-- ===== MAIN CONTENT ===== -->
  <main class="container py-5">
    <h2 class="fw-bold mb-3 text-center text-white">Analitik Lalu Lintas</h2>
    <p class="text-secondary text-center mb-4">
      Pilih lokasi CCTV untuk melihat tren kepadatan lalu lintas.
    </p>

    <!-- CCTV SELECTOR -->
    <div class="row justify-content-center mb-4">
      <div class="col-md-6">
        <select class="form-select text-center py-2" id="cctvSelect">
          <option value="">-- Pilih CCTV --</option>
          <!-- Opsi akan diisi Javascript -->
        </select>
      </div>
    </div>

    <!-- FILTER BUTTONS (Harian, Mingguan, Bulanan) -->
    <div class="text-center mb-4">
      <div class="btn-group btn-filter-group" role="group">
        <button class="btn active" onclick="changePeriod('harian', this)">Harian</button>
        <button class="btn" onclick="changePeriod('mingguan', this)">Mingguan</button>
        <button class="btn" onclick="changePeriod('bulanan', this)">Bulanan</button>
      </div>
    </div>

    <!-- CHART SECTION (Centered Single Chart) -->
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="chart-card">
          <h4 id="chartTitle">Laporan Kendaraan Harian</h4>
          <div style="position: relative; height: 550px; width: 100%;"> <!-- Height diperbesar agar label muat -->
            <canvas id="trafficChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- ===== FOOTER ===== -->
  <footer class="text-center mt-5">
    <div class="container">
      <small>© 2025 Smart Traffic Vision | Powered by Kelompok 3 5B Teknik Informatika</small>
    </div>
  </footer>

  <!-- ===== SCRIPTS ===== -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Global Vars
    let trafficChartInstance = null;
    let currentCctvId = null;
    let currentPeriod = 'harian';

    document.addEventListener('DOMContentLoaded', function () {
      // 1. Ambil Daftar CCTV
      fetch('/api/cctv_locations')
        .then(res => res.json())
        .then(data => {
          const select = document.getElementById('cctvSelect');
          data.forEach(cctv => {
            const opt = new Option(cctv.name, cctv.id);
            select.appendChild(opt);
          });
        });

      // 2. Listener Dropdown
      document.getElementById('cctvSelect').addEventListener('change', function () {
        currentCctvId = this.value;
        updateChart();
      });

      // 3. Polling Real-time (Sama dengan Admin)
      setInterval(() => {
        if (currentCctvId) updateChart();
      }, 5000);
    });

    function changePeriod(period, btnElement) {
      document.querySelectorAll('.btn-filter-group .btn').forEach(btn => btn.classList.remove('active'));
      btnElement.classList.add('active');
      currentPeriod = period;
      updateChart();
    }

    function updateChart() {
      if (!currentCctvId) return;

      // Ambil data dari API Public (Pastikan backend sudah return datasets mobil, motor, dll)
      fetch(`/api/public/traffic_data?cctv_id=${currentCctvId}&period=${currentPeriod}`)
        .then(response => response.json())
        .then(data => {
          if (!data.datasets) return;

          // LOGIKA MULTI-LINE LABELS (Tanggal + Angka)
          const multiLineLabels = data.labels.map((label, index) => {
            const m = data.datasets.mobil[index] || 0;
            const mt = data.datasets.motor[index] || 0;
            const b = data.datasets.bus[index] || 0;
            const t = data.datasets.truk[index] || 0;
            const total = m + mt + b + t;

            return [
              label,              // Baris 1: 13 Jan
              "──────────",        // Baris 2: Garis
              `Mobil : ${m}`,     // Baris 3
              `Motor : ${mt}`,    // Baris 4
              `Bus   : ${b}`,     // Baris 5
              `Truk  : ${t}`,     // Baris 6
              "──────────",        // Baris 7
              `Total : ${total}`   // Baris 8
            ];
          });

          renderTrafficChart(multiLineLabels, data.datasets);
        });
    }

    function renderTrafficChart(labels, datasets) {
      const ctx = document.getElementById('trafficChart').getContext('2d');
      if (trafficChartInstance) trafficChartInstance.destroy();

      trafficChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            { label: 'Mobil', data: datasets.mobil, backgroundColor: '#00E5FF', barThickness: 40 },
            { label: 'Motor', data: datasets.motor, backgroundColor: '#FFD600', barThickness: 40 },
            { label: 'Bus', data: datasets.bus, backgroundColor: '#00C853', barThickness: 40 },
            { label: 'Truk', data: datasets.truk, backgroundColor: '#FF5252', barThickness: 40 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              stacked: true,
              ticks: {
                color: '#ffffff',
                font: { size: 12, family: "'Poppins', sans-serif", lineHeight: 1.5 },
                padding: 10
              },
              grid: { display: false }
            },
            y: {
              stacked: true,
              beginAtZero: true,
              min: 0,
              ticks: { color: '#888' },
              grid: { color: 'rgba(255,255,255,0.05)' }
            }
          },
          plugins: {
            legend: { display: true, labels: { color: '#fff', font: { size: 12 } } },
            tooltip: { mode: 'index', intersect: false }
          }
        }
      });
    }
  </script>
</body>

</html>